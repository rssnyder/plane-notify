on: 
  workflow_dispatch:
#   schedule:
#     - cron: '*/15 * * * *'

permissions:
  contents: read
  packages: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:

    - uses: actions/checkout@v2

    - run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - run: |
        sed -i "s|webhookurl|${LOG_DISCORD_WEBHOOK_URL}|g" configs/mainconf.ini
        sed -i "s|webhookurl|${DISCORD_WEBHOOK_URL}|g" configs/plane1.ini
      env:
        LOG_DISCORD_WEBHOOK_URL: ${{ secrets.LOG_DISCORD_WEBHOOK_URL }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    - run: docker pull ghcr.io/${GITHUB_REPOSITORY}:githubactions || docker build -t ghcr.io/${GITHUB_REPOSITORY}:githubactions .
    
    - run: docker run plane-notify:githubactions

    - run: docker push ghcr.io/${GITHUB_REPOSITORY}:githubactions

